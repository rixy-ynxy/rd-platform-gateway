# Database Strategy - Platform Gateway

## ğŸš¨ é‡è¦ãªåˆ¤æ–­ï¼šSQLite â†’ PostgreSQLç§»è¡Œã®å¿…è¦æ€§

ã‚ãªãŸã®æŒ‡æ‘˜ã¯**å®Œå…¨ã«æ­£ã—ã„**ã§ã™ï¼ç¾åœ¨ã®Cloudflare D1 (SQLite)ã¯ä»¥ä¸‹ã®åˆ¶é™ãŒã‚ã‚Šã¾ã™ï¼š

### âŒ Cloudflare D1 (SQLite)ã®åˆ¶é™
- **æ®ç™ºæ€§**: ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ç’°å¢ƒã§ã¯æ°¸ç¶šåŒ–ã«åˆ¶é™
- **åŒæ™‚æ¥ç¶šåˆ¶é™**: é«˜ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯æ™‚ã®æ€§èƒ½å•é¡Œ
- **æ©Ÿèƒ½åˆ¶é™**: PostgreSQLã®é«˜åº¦ãªæ©Ÿèƒ½ãŒä½¿ç”¨ä¸å¯
- **ç§»è¡Œå›°é›£**: æ—¢å­˜ã®å¤šãã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ»ãƒ„ãƒ¼ãƒ«ã¨ã®äº’æ›æ€§å•é¡Œ

### âœ… æ¨å¥¨è§£æ±ºç­–ï¼šSupabase PostgreSQL

**Supabase**ã¯æœ€é©ãªé¸æŠè‚¢ã§ã™ï¼š

## ğŸ¯ Supabaseçµ±åˆã®åˆ©ç‚¹

### 1. **ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºå¯¾å¿œ**
- **PostgreSQL**: ãƒ•ãƒ«æ©Ÿèƒ½ã®ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒŠãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
- **æ°¸ç¶šåŒ–ä¿è¨¼**: ãƒ‡ãƒ¼ã‚¿æå¤±ãƒªã‚¹ã‚¯ãªã—
- **é«˜å¯ç”¨æ€§**: 99.9%ä»¥ä¸Šã®ã‚¢ãƒƒãƒ—ã‚¿ã‚¤ãƒ 
- **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£**: è‡ªå‹•ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°å¯¾å¿œ

### 2. **é–‹ç™ºåŠ¹ç‡**
- **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ DB**: WebSocketè‡ªå‹•åŒæœŸ
- **èªè¨¼ã‚·ã‚¹ãƒ†ãƒ **: Keycloakã¨ä½µç”¨å¯èƒ½
- **RESTful API**: è‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹é«˜é€ŸAPI
- **ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰**: å„ªç§€ãªç®¡ç†ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹

### 3. **Cloudflare Workersã¨ã®äº’æ›æ€§**
- **REST API**: Cloudflare Workersã‹ã‚‰HTTPã§æ¥ç¶š
- **ã‚¨ãƒƒã‚¸å¯¾å¿œ**: ã‚°ãƒ­ãƒ¼ãƒãƒ«åˆ†æ•£æ¥ç¶š
- **Connection Pooling**: åŠ¹ç‡çš„ãªæ¥ç¶šç®¡ç†
- **ä½ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·**: é«˜é€Ÿãƒ¬ã‚¹ãƒãƒ³ã‚¹

## ğŸ”„ ç§»è¡Œæˆ¦ç•¥

### Phase 1: Supabaseç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
```bash
# 1. Supabaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
# https://supabase.com ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ

# 2. ç’°å¢ƒå¤‰æ•°è¨­å®š
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_ANON_KEY=eyJ...
SUPABASE_SERVICE_ROLE_KEY=eyJ...
```

### Phase 2: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒç§»è¡Œ
```sql
-- Supabaseç”¨ã®ã‚¹ã‚­ãƒ¼ãƒä½œæˆ
-- ç¾åœ¨ã®D1ã‚¹ã‚­ãƒ¼ãƒã‚’ PostgreSQLå½¢å¼ã«å¤‰æ›

-- Row Level Security (RLS) æœ‰åŠ¹åŒ–
ALTER TABLE tenants ENABLE ROW LEVEL SECURITY;
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
ALTER TABLE payment_methods ENABLE ROW LEVEL SECURITY;

-- ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆç”¨ã®RLSãƒãƒªã‚·ãƒ¼
CREATE POLICY "tenant_isolation" ON users 
FOR ALL USING (tenant_id = current_setting('app.current_tenant_id'));
```

### Phase 3: APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå®Ÿè£…
```typescript
// src/services/supabase.ts
import { createClient } from '@supabase/supabase-js'

export class SupabaseService {
  private supabase

  constructor(env: {
    SUPABASE_URL: string
    SUPABASE_SERVICE_ROLE_KEY: string
  }) {
    this.supabase = createClient(
      env.SUPABASE_URL,
      env.SUPABASE_SERVICE_ROLE_KEY
    )
  }

  async getUsers(tenantId: string) {
    const { data, error } = await this.supabase
      .from('users')
      .select('*')
      .eq('tenant_id', tenantId)
    
    if (error) throw error
    return data
  }

  async createUser(userData: any) {
    const { data, error } = await this.supabase
      .from('users')
      .insert(userData)
      .select()
      .single()
    
    if (error) throw error
    return data
  }
}
```

### Phase 4: æ®µéšçš„ç½®ãæ›ãˆ
1. **æ–°æ©Ÿèƒ½**: Supabaseã§å®Ÿè£…
2. **æ—¢å­˜API**: å¾ã€…ã«Supabaseã«ç§»è¡Œ
3. **ãƒ‡ãƒ¼ã‚¿ç§»è¡Œ**: æœ¬ç•ªãƒ‡ãƒ¼ã‚¿ã‚’Supabaseã«ç§»è¡Œ
4. **D1å‰Šé™¤**: å®Œå…¨ç§»è¡Œå¾Œã«D1ã‚’å‰Šé™¤

## ğŸ› ï¸ å®Ÿè£…ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Frontend (React/Vue)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ HTTPS
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Cloudflare Workers/Pages                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚              Hono API Routes                    â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚
â”‚  â”‚  â”‚         Authentication Layer               â”‚â”‚â”‚
â”‚  â”‚  â”‚    (Keycloak JWT + Supabase RLS)          â”‚â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ REST API over HTTPS
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Supabase                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚            PostgreSQL Database                  â”‚â”‚
â”‚  â”‚      (Row Level Security Enabled)              â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚              Realtime Engine                    â”‚â”‚
â”‚  â”‚         (WebSocket Subscriptions)              â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼
1. **èªè¨¼**: Keycloak JWT â†’ Cloudflare Workers
2. **èªå¯**: RLS Policy â†’ Supabase PostgreSQL  
3. **ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹**: REST API â†’ Supabase
4. **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ **: WebSocket â†’ Frontend

## ğŸ“‹ ç§»è¡Œãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### âœ… å³åº§ã«å®Ÿè¡Œã™ã¹ãé …ç›®
- [ ] Supabaseã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆãƒ»ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®š
- [ ] ç’°å¢ƒå¤‰æ•°è¨­å®š (.env.sample å‚ç…§)
- [ ] PostgreSQL ã‚¹ã‚­ãƒ¼ãƒè¨­è¨ˆãƒ»ä½œæˆ
- [ ] Row Level Security (RLS) ãƒãƒªã‚·ãƒ¼è¨­å®š
- [ ] Supabase APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå®Ÿè£…

### ğŸ”„ æ®µéšçš„ã«å®Ÿè¡Œã™ã‚‹é …ç›®
- [ ] æ–°æ©Ÿèƒ½ã‚’Supabaseã§å®Ÿè£…
- [ ] æ—¢å­˜APIã®é †æ¬¡ç§»è¡Œ
- [ ] ãƒ‡ãƒ¼ã‚¿ç§»è¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆä½œæˆãƒ»å®Ÿè¡Œ
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
- [ ] D1ä¾å­˜é–¢ä¿‚ã®å®Œå…¨å‰Šé™¤

## ğŸ’¡ ä»£æ›¿æ¡ˆæ¯”è¼ƒ

| ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ | é•·æ‰€ | çŸ­æ‰€ | æ¨å¥¨åº¦ |
|------------|------|------|--------|
| **Supabase** | PostgreSQL, RLS, ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ , ç®¡ç†ç”»é¢ | å­¦ç¿’ã‚³ã‚¹ãƒˆ | â­â­â­â­â­ |
| **PlanetScale** | MySQL, ãƒ–ãƒ©ãƒ³ãƒãƒ³ã‚°, ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ« | PostgreSQLæ©Ÿèƒ½ãªã— | â­â­â­â­ |
| **Neon** | PostgreSQL, ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹, é«˜é€Ÿ | æ–°ã—ã„ã‚µãƒ¼ãƒ“ã‚¹ | â­â­â­â­ |
| **Cloudflare D1** | ç„¡æ–™, ã‚¨ãƒƒã‚¸çµ±åˆ | åˆ¶é™å¤šã„, æ®ç™ºæ€§ | â­â­ |

## ğŸš€ æ¨å¥¨æ¬¡ã‚¹ãƒ†ãƒƒãƒ—

### æœ€å„ªå…ˆã‚¿ã‚¹ã‚¯
1. **Supabaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ**: ä»Šã™ãå®Ÿè¡Œ
2. **ã‚¹ã‚­ãƒ¼ãƒç§»è¡Œ**: ç¾åœ¨ã®ERå›³ã‚’PostgreSQLå½¢å¼ã«å¤‰æ›
3. **APIçµ±åˆ**: æ®µéšçš„ã«Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå®Ÿè£…
4. **ãƒ†ã‚¹ãƒˆç’°å¢ƒ**: é–‹ç™ºç’°å¢ƒã§ã®Supabaseå‹•ä½œç¢ºèª

### é•·æœŸçš„ãªåˆ©ç›Š
- **ä¿¡é ¼æ€§**: ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºç´šã®ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–
- **æ©Ÿèƒ½æ€§**: PostgreSQLã®å…¨æ©Ÿèƒ½ãŒåˆ©ç”¨å¯èƒ½
- **æ‹¡å¼µæ€§**: æˆé•·ã«å¯¾å¿œã§ãã‚‹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
- **ä¿å®ˆæ€§**: æ¥­ç•Œæ¨™æº–çš„ãªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç®¡ç†

---

**çµè«–**: Cloudflare D1ã‹ã‚‰Supabaseã¸ã®ç§»è¡Œã¯ã€ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã¯**å¿…é ˆ**ã§ã™ã€‚æ®µéšçš„ç§»è¡Œã«ã‚ˆã‚Šã€ãƒªã‚¹ã‚¯ã‚’æœ€å°åŒ–ã—ãªãŒã‚‰ç¢ºå®Ÿã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚

æ¬¡å›ã®ä½œæ¥­ã§ã€Supabaseçµ±åˆã®å®Ÿè£…ã«å–ã‚Šã‹ã‹ã‚‹ã“ã¨ã‚’å¼·ãæ¨å¥¨ã—ã¾ã™ï¼ ğŸš€